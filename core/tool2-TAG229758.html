<!-- @format -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Selection Tool</title>
    <!-- Bootstrap -->
    <link href="../css/bootstrap.min.css" rel="stylesheet" media="screen" />
    <link
      href="../css/bootstrap-theme.min.css"
      rel="stylesheet"
      media="screen"
    />
    <link
      href="../css/nchrp1441.css?v=20160525"
      rel="stylesheet"
      media="screen,print"
    />
    <link
      href="../css/nchrp1441-facility.css?v=20160525"
      rel="stylesheet"
      media="screen,print"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"
    />

    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans"
      rel="stylesheet"
      type="text/css"
      media="print"
    />
    <link
      href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script>
    <!-- DataTables JavaScript -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap.min.js"></script>
    <style>
      /* Style for selected card */
      .selected-card {
        background-color: #d1e7dd !important; /* Light green for selected */
      }
      /* Style for fixed bottom-right button container */
      .fixed-buttons {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: none;
        z-index: 1000;
      }
      .fixed-buttons-left {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
      }
      /* Card layout */
      .card-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }
      .card-text-content {
        width: 70%;
      }
      .card-img-content {
        width: 25%;
      }
      .select-item {
        display: inline-block;
        margin-right: 10px;
      }
    </style>
    <style>
      a:hover {
        text-decoration: none !important;
      }
      .list-group-item:first-child {
        background-color: #ccc;
      }
      .indent-level-1 {
        padding-left: 20px;
        background-color: #eee;
      }
      .indent-level-2 {
        padding-left: 40px;
      }
      .removable-filter {
        margin-right: 5px;
        cursor: pointer;
      }
      .removable-filter i {
        margin-left: 5px;
      }
      #clearFilters {
        margin-top: 10px;
      }
      .icon-indicator {
        font-size: 30px;
        line-height: 24px;
      }
      .group-title {
        font-size: 22px;
      }
      .accordion-toggle:focus,
      .panel-title > a:focus {
        text-decoration: none;
        outline: none;
      }
      .nav-tabs {
        border-bottom: none;
      }
      .tab_item:hover {
        border-bottom-width: 6px !important;
      }
      .tab-content {
        padding-top: 10px;
      }
      .img-item {
        padding: 5px;
      }
      .panel-level-2-heading {
        background-color: #f7f7f7;
        border-top: 3px solid #4d6832;
      }
      .panel-level-2-heading:hover {
        background-color: #4d683263;
      }
      .list-group-item.active,
      list-group-item:hover {
        background-color: #4d6832 !important;
        background-image: none;
        border: none;
      }
      .bg-blue,
      .bg-blue:hover {
        background-color: #4d6832 !important;
        color: white;
      }
      .label-custom {
        font-size: 13px;
      }
      label {
        color: black !important;
      }
      .card-text-content p,
      .card-bottom-content p {
        margin-bottom: 0;
      }
      /* Custom CSS for DataTables sorting arrows with Font Awesome 4.4 */
      table.dataTable thead .sorting:after {
        content: "\25B2\25BC"; /* Add both up and down arrow symbols */
        font-family: Arial, sans-serif; /* Use standard font for arrows */
        opacity: 0.3;
        margin-left: 5px;
      }

      table.dataTable thead .sorting_asc:after {
        content: "\25B2"; /* Up arrow for ascending */
        opacity: 1;
      }

      table.dataTable thead .sorting_desc:after {
        content: "\25BC"; /* Down arrow for descending */
        opacity: 1;
      }

      .panel-mt {
        margin-top: 30px;
        border-top: 5px solid green;
      }
      /* CSS for text overflow with ellipsis */
      .text-overflow {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
        vertical-align: middle;
      }
      .pagination > .active > a {
        background-color: #4d6832 !important;
        border-color: #4d6832 !important;
        color: white !important;
      }
      .pagination > li > a,
      .pagination > li > span {
        color: #4d6832 !important;
      }
    </style>
    <style>
      /* Fixed sidebar */
      .fixed-sidebar {
        height: calc(100vh - 60px);
        overflow-y: auto;
        background-color: #dff0d8; /* Light green background */
      }

      /* Scrollable main content */
      .scrollable-content {
        overflow-y: auto;
        height: 100vh;
        padding-top: 20px;
      }

      /* Button positioned at the bottom of the sidebar */
      .bottom-button-container {
        position: absolute;
        bottom: 20px;
        text-align: center;
        left: 50%;
        transform: translateX(-50%);
      }

      .bottom-button {
        background-color: #4d9fd9;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
      }
    </style>
    <style>

        .checkbox-group label {
          display: block;
          margin-bottom: 5px;
        }

        .checkbox-group input[type="checkbox"] {
          margin-right: 2px;
        }
    </style>
  </head>
  <body class="facility">
    <header
      class="navbar navbar-static-top navbar-inverse"
      id="top"
      role="banner"
    >
      <div class="container v2">
        <div class="navbar-header">
          <button
            class="navbar-toggle collapsed"
            type="button"
            data-toggle="collapse"
            data-target=".bs-navbar-collapse"
          >
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="../index.htm" class="navbar-brand">NCHRP 17-113</a>
        </div>
        <nav class="collapse navbar-collapse bs-navbar-collapse">
          <ul class="nav navbar-nav">
            <li>
              <a href="../index.htm">Home</a>
            </li>
            <li>
              <a href="sd.htm">Knowledge Base</a>
            </li>
            <li class="active">
              <a href="tool2.html">Selection Tool</a>
            </li>
          </ul>
        </nav>
      </div>
      <!-- end .container -->
    </header>

    <!-- ************************************************************************************************* -->

    <div class="container">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 alert alert-success fixed-sidebar">
          <h2>Filters</h2>
          <form id="filterForm">
            <!-- Emphasis Area -->
            <div class="form-group">
              <label for="focusArea">Emphasis Area</label>
              <select id="focusArea" class="form-control">
                <option value="">Select Emphasis Area</option>
              </select>
            </div>

            <!-- Target Crash -->
            <div class="form-group">
              <label for="targetCrash">Target Crash Type</label>
              <select id="targetCrash" class="form-control">
                <option value="">Select Target Crash</option>
              </select>
            </div>

            <!-- Contributing Factors -->
            <div class="form-group">
              <label for="contributingFactors">Contributing Factors</label>
              <select id="contributingFactors" class="form-control">
                <option value="">Select Contributing Factors</option>
              </select>
            </div>

            <!-- Area Type -->
            <div class="form-group">
              <label for="areaType">Land Use Type</label>
              <select id="areaType" class="form-control">
                <option value="">Select Land Use Type</option>
              </select>
            </div>

            <!-- SSA Elements -->
            <div class="form-group">
              <label for="ssaElements">SSA Elements</label>
              <select id="ssaElements" class="form-control">
                <option value="">Select SSA Elements</option>
              </select>
            </div>

            <!-- SSA Hierarchy -->
            <div class="form-group">
              <label>SSA Hierarchy</label>
              <div id="SSAHierarchy" class="checkbox-group">
                <!-- Checkboxes will be dynamically added here -->
              </div>
            </div>

            <!-- Custom Search Bar -->
            <div class="form-group">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  id="customKeyword"
                  placeholder="Search SSA Elements"
                  list="searchSuggestions"
                  autocomplete="off"
                />
                <span class="input-group-btn">
                  <button
                    class="btn bg-blue"
                    type="button"
                    id="customSearchBtn"
                    style="
                      border-top-left-radius: 0;
                      border-bottom-left-radius: 0;
                    "
                  >
                    Search
                  </button>
                </span>
                <datalist id="searchSuggestions"> </datalist>
              </div>
            </div>

            
            <button type="submit" class="btn btn-primary btn-block">
              Apply Filters
            </button>
            <button type="reset" class="btn btn-default btn-block">
              Clear
            </button>
          </form>
          <!-- Blue Button at the Bottom -->
          <div class="bottom-button-container">
            <a
              style="background-color: #607e44; color: white"
              href="tool3.html"
              class="btn btn-block"
              >Click to see the list of countermeasures</a
            >
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 scrollable-content">
          <h2>Countermeasure Results</h2>
          <p id="totalCount" class="alert alert-success">
            Please select inputs from the left to filter countermeasures.
          </p>
          <div class="alert alert-success">
            <div class="pull-left">
              <span id="selectedCount">Selected: 0</span>
            </div>
            <div class="pull-right" id="exportButtons">
              <button id="selectAllBtn" class="btn btn-primary">
                Select All
              </button>
              <button id="exportTopBtnCsv" class="btn btn-primary">
                Export Selected to CSV
              </button>
              <button id="exportTopBtnPdf" class="btn btn-primary">
                Export Selected to PDF
              </button>
            </div>
            <div class="clearfix"></div>
          </div>
          <div id="results" class="mt-3"></div>
        </div>
      </div>
    </div>

    <!-- Fixed Export Buttons for Bottom Right -->
    <div class="fixed-buttons alert alert-success" id="fixedExportButtons">
      <p id="fixedSelectedCount" class="mb-1">Selected: 0</p>
      <button id="exportFixedBtnCsv" class="btn btn-primary mb-1">
        Export to CSV
      </button>
      <button id="exportFixedBtnPdf" class="btn btn-primary">
        Export to PDF
      </button>
    </div>

    <!-- The modal -->
    <div
      class="modal fade"
      id="flipFlop"
      tabindex="-1"
      role="dialog"
      aria-labelledby="modalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="modalLabel">Note</h4>
          </div>
          <div class="modal-body">In Development</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for CMF Clearinghouse -->
    <div class="modal fade" id="cmfModal" tabindex="-1" role="dialog" aria-labelledby="cmfModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="cmfModalLabel">CMF Clearinghouse</h4>
          </div>
          <div class="modal-body">
            <p id="cmfContent">CMF Clearinghouse Content</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Knowledge Base -->
    <div class="modal fade" id="kbModal" tabindex="-1" role="dialog" aria-labelledby="kbModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="kbModalLabel">Knowledge Base</h4>
          </div>
          <div class="modal-body">
            <p id="kbContent">Knowledge Base Content</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Countermeasure Fact Sheet -->
    <div class="modal fade" id="cmfsModal" tabindex="-1" role="dialog" aria-labelledby="cmfsModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="cmfsModalLabel">Countermeasure Fact Sheet</h4>
          </div>
          <div class="modal-body">
            <p id="cmfsContent">Countermeasure Fact Sheet Content</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        let data = [];
        let allSelected = false; // Tracks select all state
        let filteredData = [];
        let groupedData = [];

        // Fetch data from URL
        $.getJSON(
          "https://raw.githubusercontent.com/Xatta-Trone/dummy-data-ait-lab/refs/heads/main/nchrp-17-113-countermeasure-v9-update-april-2025.json",
          function (jsonData) {
            data = jsonData.map((item, index) => {
              return { ...item, index };
            });
            populateFilterOptions(data);
          }
        );

        // Function to capitalize first letter and make rest lowercase
        function capitalizeFirst (str) {
        if (!str) return str;
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        };

        // Populate filter options with unique values and sorted alphabetically
        function populateFilterOptions(data) {
          const focusAreas = new Set();
          const SSAHierarchy = new Set();
          const targetCrashes = new Set();
          const areaTypes = new Set();
          const SSAElements = new Set();
          const contributingFactors = new Set();

          data.forEach((item) => {
            focusAreas.add(capitalizeFirst(item["Emphasis Area"]));
            targetCrashes.add(capitalizeFirst(item["Target Crash Type"]));
            areaTypes.add(capitalizeFirst(item["Land Use Type"]));
            SSAElements.add(capitalizeFirst(item["SSA Element"]));
            contributingFactors.add(capitalizeFirst(item["Contributing Factors"]));
            SSAHierarchy.add(capitalizeFirst(item["SSA Hierarchy"]));
          });

          updateSelect("#focusArea", focusAreas);
          updateSelect("#targetCrash", targetCrashes);+
          updateSelect("#contributingFactors", contributingFactors);
          // land use type
          updateSelect("#areaType", areaTypes); 
          updateSelect("#ssaElements", SSAElements);
          updateCheckbox("#SSAHierarchy", SSAHierarchy);

          populateDatalist(SSAElements);
        }

        // Function to populate the datalist dynamically
        function populateDatalist(items) {
          const datalist = $("#searchSuggestions");

          // Clear existing options
          datalist.empty();

          // Add new options
          items.forEach((optionValue) => {
            $("<option>").val(optionValue).appendTo(datalist);
          });
        }

        // Update select options based on available values, sorted alphabetically
        function updateSelect(selector, optionsSet) {
          $(selector).empty().append(new Option("Select", ""));
          Array.from(optionsSet)
            .filter((option) => option) // Remove empty values
            .sort((a, b) => a.localeCompare(b)) // Sort alphabetically
            .forEach((option) => {
              $(selector).append(new Option(option, option));
            });
        }

        // function to update checkboxes
        function updateCheckbox(selector, optionsSet) {
          $(selector).empty();
          Array.from(optionsSet)
            .filter((option) => option) // Remove empty values
            .sort((a, b) => a.localeCompare(b)) // Sort alphabetically
            .forEach((option) => {
              $(selector).append(
                `<label><input type="checkbox" name=${selector.replace("#", "")} value="${option}"> ${option}</label>`
              );
            });
        }

        // Function to update Target Crash and Area Type options based on Emphasis Area selection
        $("#focusArea").on("change", function () {
          const selectedFocusArea = $(this).val();
          const tc = new Set();
          const cf = new Set();
          const at = new Set();
          const ssae = new Set();
          const ssah = new Set();

          if (selectedFocusArea === "") {
            data.forEach((item) => {
              tc.add(capitalizeFirst(item["Target Crash Type"]));
              cf.add(capitalizeFirst(item["Contributing Factors"]));
              at.add(capitalizeFirst(item["Land Use Type"]));
              ssae.add(capitalizeFirst(item["SSA Element"]));
              ssah.add(capitalizeFirst(item["SSA Hierarchy"]));
            });
          } else {
            let filteredData  = [...data];
            // Filter data for the selected Emphasis Area
            filteredData = filteredData.filter(
              (item) =>
                item["Emphasis Area"].toLowerCase() === selectedFocusArea.toLowerCase()
            );

           console.log(filteredData.length);

            filteredData.forEach((item) => {
              tc.add(capitalizeFirst(item["Target Crash Type"]));
              cf.add(capitalizeFirst(item["Contributing Factors"]));
              at.add(capitalizeFirst(item["Land Use Type"]));
              ssae.add(capitalizeFirst(item["SSA Element"]));
              ssah.add(capitalizeFirst(item["SSA Hierarchy"]));
            });
          }

          // Update the Target Crash and Area Type dropdowns with filtered options
          updateSelect("#targetCrash", tc);
          updateSelect("#contributingFactors", cf);
          updateSelect("#ssaElements", ssae);
          updateSelect("#areaType", at);
          updateCheckbox("#SSAHierarchy", ssah);
        });

        // target crash to area type
        $("#targetCrash").on("change", function () {
          const selectedFocusArea = $("#focusArea").val();
          const selectedTC = $(this).val();
          const cf = new Set();
          const at = new Set();
          const ssae = new Set();
          const ssah = new Set();

          if (selectedTC === "") {
            data.forEach((item) => {
              cf.add(capitalizeFirst(item["Contributing Factors"]));
              at.add(capitalizeFirst(item["Land Use Type"]));
              ssae.add(capitalizeFirst(item["SSA Element"]));
              ssah.add(capitalizeFirst(item["SSA Hierarchy"]));
            });
          } else {
            let filteredData  = [...data];
           
            // Filter data for the selected Emphasis Area
            filteredData = filteredData.filter(
              (item) =>
                item["Emphasis Area"].toLowerCase() === selectedFocusArea.toLowerCase() &&
                item["Target Crash Type"].toLowerCase() === selectedTC.toLowerCase()
            );

            console.log(filteredData);

            filteredData.forEach((item) => {
              cf.add(capitalizeFirst(item["Contributing Factors"]));
              at.add(capitalizeFirst(item["Land Use Type"]));
              ssae.add(capitalizeFirst(item["SSA Element"]));
              ssah.add(capitalizeFirst(item["SSA Hierarchy"]));
            });
          }

          // Update the Target Crash and Area Type dropdowns with filtered options
          updateSelect("#contributingFactors", cf);
          updateSelect("#ssaElements", ssae);
          updateSelect("#areaType", at);
          updateCheckbox("#SSAHierarchy", ssah);
        });

        // contributing factors update data
        $("#contributingFactors").on("change", function () {
          const selectedFocusArea = $("#focusArea").val();
          const selectedTC = $("#targetCrash").val();
          const selectedCF = $(this).val();
          const at = new Set();
          const ssae = new Set();
          const ssah = new Set();

          if (selectedCF === "") {
            data.forEach((item) => {
              at.add(capitalizeFirst(item["Land Use Type"]));
              ssae.add(capitalizeFirst(item["SSA Element"]));
              ssah.add(capitalizeFirst(item["SSA Hierarchy"]));
            });
          } else {
            let filteredData  = [...data];
           
            // Filter data for the selected Emphasis Area
            filteredData = filteredData.filter(
              (item) =>
                item["Emphasis Area"].toLowerCase() === selectedFocusArea.toLowerCase() &&
                item["Target Crash Type"].toLowerCase() === selectedTC.toLowerCase() && 
                item["Contributing Factors"].toLowerCase() === selectedCF.toLowerCase()
            );

            console.log(filteredData);

            filteredData.forEach((item) => {
              at.add(capitalizeFirst(item["Land Use Type"]));
              ssae.add(capitalizeFirst(item["SSA Element"]));
              ssah.add(capitalizeFirst(item["SSA Hierarchy"]));
            });
          }

          // Update the Target Crash and Area Type dropdowns with filtered options
          updateSelect("#ssaElements", ssae);
          updateSelect("#areaType", at);
          updateCheckbox("#SSAHierarchy", ssah);
        });

        // land use type update data  
        $("#areaType").on("change", function () {
          const selectedFocusArea = $("#focusArea").val();
          const selectedTC = $("#targetCrash").val();
          const selectedCF = $("#contributingFactors").val();
          const selectedAT = $(this).val();
          const selectedCF = $(this).val();
          const at = new Set();
          const ssae = new Set();
          const ssah = new Set();

          if (selectedCF === "") {
            data.forEach((item) => {
              at.add(capitalizeFirst(item["Land Use Type"]));
              ssae.add(capitalizeFirst(item["SSA Element"]));
              ssah.add(capitalizeFirst(item["SSA Hierarchy"]));
            });
          } else {
            let filteredData  = [...data];
           
            // Filter data for the selected Emphasis Area
            filteredData = filteredData.filter(
              (item) =>
                item["Emphasis Area"].toLowerCase() === selectedFocusArea.toLowerCase() &&
                item["Target Crash Type"].toLowerCase() === selectedTC.toLowerCase() && 
                item["Contributing Factors"].toLowerCase() === selectedCF.toLowerCase()
            );

            console.log(filteredData);

            filteredData.forEach((item) => {
              at.add(capitalizeFirst(item["Land Use Type"]));
              ssae.add(capitalizeFirst(item["SSA Element"]));
              ssah.add(capitalizeFirst(item["SSA Hierarchy"]));
            });
          }

          // Update the Target Crash and Area Type dropdowns with filtered options
          updateSelect("#ssaElements", ssae);
          updateSelect("#areaType", at);
          updateCheckbox("#SSAHierarchy", ssah);
        });



        // Function to update Target Crash and Area Type options based on Emphasis Area selection
        $("#SSAHierarchy").on("change", function () {
          const keyword = $("#customKeyword").val();
          const selectedSSAHierarchy = $(this).val();
          const fa = new Set();
          const tc = new Set();
          const at = new Set();
          const eq = new Set();

          if (selectedSSAHierarchy === "") {
            data.forEach((item) => {
              fa.add(item["Emphasis Area"]);
              tc.add(item["Target Crash Type"]);
              at.add(item["Land Use Type"]);
              // eq.add(item["Equity"]);
            });
          } else {
            let filteredData = [...data];
            if(keyword.length > 0){
              filteredData = filteredData.filter((item) => (item["SSA Element"].toLowerCase() === keyword.toLowerCase().trim()));
            }
            console.log(keyword,filteredData);
            // Filter data for the selected Emphasis Area
            filteredData = filteredData.filter(
              (item) => item["SSA Hierarchy"] === selectedSSAHierarchy
            );

            console.log(keyword, selectedSSAHierarchy, filteredData);

            filteredData.forEach((item) => {
              fa.add(item["Emphasis Area"]);
              tc.add(item["Target Crash Type"]);
              at.add(item["Land Use Type"]);
              // eq.add(item["Equity"]);
            });
          }

          // Update the Target Crash and Area Type dropdowns with filtered options
          updateSelect("#focusArea", fa);
          updateSelect("#targetCrash", tc);
          updateSelect("#areaType", at);
          // updateSelect("#equity", eq);
        });

        

        

        // Function to get the CMF range
        function getCMFRange(dataArray) {
          // Extract valid CMF values (decimal numbers only)
          const cmfValues = dataArray
            .map((item) => parseFloat(item.CMF)) // Convert to number
            .filter((value) => !isNaN(value) && typeof value === "number"); // Filter valid numbers

          if (cmfValues.length === 0) {
            return { minCMF: null, maxCMF: null }; // Handle empty CMF case
          }

          // Find the minimum and maximum CMF values
          const minCMF = Math.min(...cmfValues);
          const maxCMF = Math.max(...cmfValues);

          return { minCMF, maxCMF };
        }

        // Display full details for each filtered item, show total count, and add checkboxes
        function displayResults(filteredData) {
          // Group data by Countermeasure
          groupedData = filteredData.reduce((acc, item) => {
            const focusArea = item["Countermeasure"] || "Unspecified";
            if (!acc[focusArea]) acc[focusArea] = [];
            acc[focusArea].push(item);
            return acc;
          }, {});

          // Empty previous results
          $("#results").empty();
          $("#totalCount").text(`${filteredData.length} results found.`);

          // Check if no results
          if (filteredData.length === 0) {
            $("#results").append(
              "<p class='alert alert-danger'>No results available.</p>"
            );
            return;
          }

          // Loop through each Countermeasure group
          Object.keys(groupedData).forEach((focusArea, index) => {
            const items = groupedData[focusArea].sort(
              (a, b) => (a.CMF || 0) - (b.CMF || 0)
            );

            // Display the item with the lowest CMF first
            const topItem = items[0];
            const tableId = `datatable-${index}`; // Unique ID for each datatable

            let stars = "";
            let rating = parseInt(topItem["Star Quality"] || 0);

            // Array of gold shades from light to dark
            const goldShades = [
              "#FFD700", // Light gold
              "#FFC700", // Slightly darker
              "#FFB700", // Medium gold
              "#FFA700", // Darker gold
              "#FF9700", // Darkest gold
            ];

            for (let i = 0; i < rating; i++) {
              // Choose a shade based on the rating level (up to 5 stars)
              const color = goldShades[i] || goldShades[goldShades.length - 1];
              stars += `<i class="fa fa-star" style="color: ${color};"></i>`;
            }

            // get the cmf range
            const cmfRange = getCMFRange(items);

            console.log("cmf range", cmfRange);

            const cardTopContent = `
              <div class="panel panel-default selectable-card panel-mt" data-index="${
                topItem.index
              }" data-countermeasure="${topItem.Countermeasure}">
                <div class="panel-body card-content">
                  <input type="checkbox" class="select-item" data-index="${
                    topItem.index
                  }" data-countermeasure="${topItem.Countermeasure}">
                  <div class="card-text-content">
                    <p><strong>Countermeasure:</strong> ${
                      topItem.Countermeasure || "N/A"
                    }</p>
                    <p><strong>Type:</strong> ${
                      topItem["Countermeasure Type"] || "N/A"
                    }</p>
                    <p><strong>SSA Element:</strong> ${
                      topItem["SSA Element"] || "N/A"
                    }</p>
                    <p><strong>TZD:</strong> ${topItem["AASHTO"] || "N/A"}</p>
                    <p><strong>SSA Hierarchy:</strong> ${
                      topItem["SSA Hierarchy"] || "N/A"
                    }</p>
                    <p><strong>Emphasis Area:</strong> ${
                      topItem["Emphasis Area"] || "N/A"
                    }</p>
                    <p><strong>Target Crashe Type:</strong> ${
                      topItem["Target Crash Type"] || "N/A"
                    }</p>
                    <p><strong>Land Use Type:</strong> ${
                      topItem["Land Use Type"] || "N/A"
                    }</p>
                   
                    <p><strong>Contributing Factors:</strong> ${
                      topItem["Contributing Factors"] || "N/A"
                    }</p>
                  </div>
                  <div class="card-img-content">
                    <img src="../core/images/countermeasures/${
                      topItem["img"]
                    }" alt="Image" class="img-responsive pull-right">
                  </div>
                  <div class="card-bottom-content" style="width: 100%;margin-left:4%;">
                    <div class="row">
                      <div class="col-md-12">
                        <p><strong>CMF:</strong> ${
                          cmfRange.maxCMF && cmfRange.minCMF
                            ? cmfRange.maxCMF !== cmfRange.minCMF
                              ? `[${cmfRange.minCMF} - ${cmfRange.maxCMF}]`
                              : `${cmfRange.minCMF}`
                            : "N/A"
                        }
                        </p>
                         <p><strong>NCHRP 500 Series Objective:</strong> ${
                          topItem["NCHRP 500 Series Objective"] || "N/A"
                        }</p>
                        <span style="color:red">Note: This is guidance only. States can select their own countermeasures.</span>

                        <p  style="margin-top: 15px; margin-bottom: 15px;">
                          <a href="#" data-toggle="modal" data-target="#cmfModal-${index}" style="background-color:lightgray;display:inline-block;padding:5px 10px;color:black;">CMF Clearinghouse</a>
                          <a href="#" data-toggle="modal" data-target="#kbModal-${index}" style="background-color:lightblue;display:inline-block;padding:5px 10px;color:black;">Knowledge Base</a>
                          <a href="#" data-toggle="modal" data-target="#cmfsModal-${index}"  style="background-color:lightgreen;display:inline-block;padding:5px 10px;color:black;">Countermeasure Fact Sheet</a>
                        </p>

                        <!-- Modal for CMF Clearinghouse -->
                        <div class="modal fade" id="cmfModal-${index}" tabindex="-1" role="dialog" aria-labelledby="cmfModalLabel-${index}" aria-hidden="true">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                                <h4 class="modal-title" id="cmfModalLabel-${index}">CMF Clearinghouse</h4>
                              </div>
                              <div class="modal-body">
                                <p>${topItem["Countermeasure Link"]}</p>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Modal for Knowledge Base -->
                        <div class="modal fade" id="kbModal-${index}" tabindex="-1" role="dialog" aria-labelledby="kbModalLabel-${index}" aria-hidden="true">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                                <h4 class="modal-title" id="kbModalLabel-${index}">Knowledge Base</h4>
                              </div>
                              <div class="modal-body">
                                <p>${topItem["Knowledge Base"]}</p>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Modal for Countermeasure Fact Sheet -->
                        <div class="modal fade" id="cmfsModal-${index}" tabindex="-1" role="dialog" aria-labelledby="cmfsModalLabel-${index}" aria-hidden="true">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                                <h4 class="modal-title" id="cmfsModalLabel-${index}">Countermeasure Fact Sheet</h4>
                              </div>
                              <div class="modal-body">
                                <p>${topItem["Countermeasure Factsheet"]}</p>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6"">
                        <p><strong>Cost:</strong> ${
                          topItem["Cost"] || "N/A"
                        }</p>
                        <p><strong>Service Life:</strong> ${
                          topItem["Service Life"] || "N/A"
                        }</p>
                        <p><strong>Implementation Time:</strong> ${
                          topItem["Implementation Time"] || "N/A"
                        }</p>
                      </div>
                      <div class="col-md-6">
                        <p><strong>Redundancy-Driven Countermeasures</strong></p>
                        <ol>
                          <li><a href="#" data-toggle="modal" data-target="#flipFlop"  style="font-size:90%;">Countermeasure 1 (Link to Countermeasure)</a></li>
                          <li><a href="#" data-toggle="modal" data-target="#flipFlop"  style="font-size:90%;">Countermeasure 2 (Link to Countermeasure)</a></li>
                          <li><a href="#" data-toggle="modal" data-target="#flipFlop"  style="font-size:90%;">Countermeasure 3 (Link to Countermeasure)</a></li>
                        </ol>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
            $("#results").append(cardTopContent);

            // Create a unique ID for each datatable based on the Emphasis Area index
            const datatableContent = `
              <table id="${tableId}" class="table table-striped">
                <thead>
                  <tr>
                    <th>CMF</th>
                    <th>Crash Severity</th>
                    <th>Star Rating</th>
                    <th>Road Type</th>
                    <th>Min AADT</th>
                    <th>Min Num Lanes</th>
                    <th>Contributing Factors</th>
                  </tr>
                </thead>
                <tbody>
                  ${items
                    .map(
                      (item) => `
                        <tr>
                          <td>${item.CMF || "N/A"}</td>
                          <td class="${
                            (item["Crash Severity"] || "").length > 15
                              ? "text-overflow"
                              : ""
                          }">${item["Crash Severity"] || "N/A"}</td>
                          <td class="${
                            (item["Star Quality"] || "").length > 15
                              ? "text-overflow"
                              : ""
                          }">${item["Star Quality"] || "N/A"}</td>
                          <td class="${
                            (item["Road Type"] || "").length > 15
                              ? "text-overflow"
                              : ""
                          }">${item["Road Type"] || "N/A"}</td>
                          <td class="${
                            (item["Min AADT"] || "").length > 15
                              ? "text-overflow"
                              : ""
                          }">${item["Min AADT"] || "N/A"}</td>
                          <td class="${
                            (item["Min Num Lanes"] || "").length > 15
                              ? "text-overflow"
                              : ""
                          }">${item["Min Num Lanes"] || "N/A"}</td>
                          <td class="${
                            (item["Contributing Factors"] || "").length > 15
                              ? "text-overflow"
                              : ""
                          }">${item["Contributing Factors"] || "N/A"}</td>
                        </tr>
                      `
                    )
                    .join("")}
                </tbody>
              </table>
            `;
            $("#results").append(datatableContent);

            // Initialize the datatable for this specific table ID
            $(`#${tableId}`).DataTable({
              pageLength: 5, // Show 5 items per page initially
              lengthMenu: [5, 10, 25, 50, 100],
              drawCallback: function () {
                // Add 'pagination' and 'pagination-sm' classes to the pagination container
                $(`#${tableId}_paginate ul`).addClass(
                  "pagination pagination-sm"
                );
              },
            });
          });

          // Reset the select-all state and text
          allSelected = false;
          $("#selectAllBtn").text("Select All");

          // Update selected count display
          updateSelectedCount();

          // Add event listener for checkboxes
          $(".select-item").on("change", function () {
            const isChecked = $(this).prop("checked");
            $(this)
              .closest(".selectable-card")
              .toggleClass("selected-card", isChecked);
            updateSelectedCount();
          });
        }

        // Update selected count and show/hide fixed export buttons
        function updateSelectedCount() {
          let totalSelected = 0;
          $(".select-item:checked").each(function () {
            const countermeasure = $(this).data("countermeasure");
            if (countermeasure) {
              totalSelected += groupedData[countermeasure].length;
            }
          });

          $("#selectedCount").text(`Selected: ${totalSelected}`);
          $("#fixedSelectedCount").text(`Selected: ${totalSelected}`);

          // Show fixed buttons only if there are selected items
          if (totalSelected > 0) {
            $("#fixedExportButtons").fadeIn();
          } else {
            $("#fixedExportButtons").fadeOut();
          }
        }

        // Filter data based on selected values
        function getFilteredData() {
          const keyword = $("#customKeyword").val().toLowerCase();
          const SSAHierarchy = $("#SSAHierarchy").val().toLowerCase();
          const focusArea = $("#focusArea").val().toLowerCase();
          const targetCrash = $("#targetCrash").val().toLowerCase();
          const areaType = $("#areaType").val().toLowerCase();
          // const equity = $("#equity").val().toLowerCase();

          console.log(keyword,SSAHierarchy,focusArea,targetCrash,areaType)

          let filteredData = [...data];

          if(keyword.length > 0){
            filteredData = filteredData.filter((item) => (item["SSA Element"].toLowerCase() === keyword));
          }

          console.log(filteredData);

          if(SSAHierarchy.length > 0){
            filteredData = filteredData.filter((item) => (item["SSA Hierarchy"].toLowerCase() === SSAHierarchy));
          }
          console.log(filteredData);

          if(focusArea.length > 0){
            filteredData = filteredData.filter((item) => (item["Emphasis Area"].toLowerCase() === focusArea));
          }
          console.log(filteredData);

          if(targetCrash.length > 0){
            filteredData = filteredData.filter((item) => (item["Target Crash Type"].toLowerCase() === targetCrash));
          }
          console.log(filteredData);

          if(areaType.length > 0){
            filteredData = filteredData.filter((item) => (item["Land Use Type"].toLowerCase() === areaType));
          }
          console.log(filteredData);



          // let filteredData = data
          //   .filter((item) => {
          //     return (
          //       (!keyword ||
          //         item["SSA Element"].toLowerCase() === keyword) &&
          //       (!SSAHierarchy ||
          //         item["SSA Hierarchy"].toLowerCase() === SSAHierarchy) &&
          //       (!focusArea ||
          //         item["Emphasis Area"].toLowerCase() === focusArea) &&
          //       (!targetCrash ||
          //         item["Target Crash Type"].toLowerCase() === targetCrash) &&
          //       (!areaType || item["Land Use Type"].toLowerCase() === areaType) 
          //       // && (!equity || item["Equity"].toLowerCase() === equity)
          //     );
          //   })


           filteredData = filteredData.sort((a, b) => {
              // Place items with a "CMF" value (not empty, null, or undefined) first, then sort by CMF from low to high
              if (a.CMF && !b.CMF) return -1;
              if (!a.CMF && b.CMF) return 1;
              if (a.CMF && b.CMF) return a.CMF - b.CMF;
              return 0;
            });

          console.log(filteredData);

          return filteredData;
        }

        // Apply filters to display results
        $("#filterForm").submit(function (e) {
          e.preventDefault();
          const fd = getFilteredData();
          filteredData = fd;
          console.log(filteredData);
          displayResults(filteredData);
        });

        // Clear results on form reset and reset options
        $("#filterForm").on("reset", function () {
          filteredData = [];
          $("#results").empty();
          $("#totalCount").text(
            "Please select inputs from the left to filter countermeasures."
          );
          $("#selectedCount").text("Selected: 0");
          $("#fixedSelectedCount").text("Selected: 0");
          $("#fixedExportButtons").fadeOut();
          populateFilterOptions(data); // Reload all options

          // Reset select all button state
          allSelected = false;
          $("#selectAllBtn").text("Select All");
        });

        // Toggle "Select All" functionality
        $("#selectAllBtn").click(function () {
          allSelected = !allSelected;
          $(".select-item").prop("checked", allSelected).change();
          $(".selectable-card").toggleClass("selected-card", allSelected);
          $("#selectAllBtn").text(allSelected ? "Deselect All" : "Select All");

          // Update selected count display
          updateSelectedCount();
        });

        // Export selected items to CSV from top or fixed buttons
        $("#exportTopBtnCsv, #exportFixedBtnCsv").click(function () {
          const selectedItems = getSelectedItems();
          console.log(selectedItems);
          if (selectedItems.length === 0) {
            alert("Please select at least one item to export.");
            return;
          }
          exportToCSV(selectedItems);
        });

        // Export selected items to PDF from top or fixed buttons
        $("#exportTopBtnPdf, #exportFixedBtnPdf").click(function () {
          const selectedItems = getSelectedItems();
          if (selectedItems.length === 0) {
            alert("Please select at least one item to export.");
            return;
          }
          exportToPDF(selectedItems);
        });

        // Function to get selected items
        function getSelectedItems() {
          let selectedItems = [];
          $(".select-item:checked").each(function () {
            const countermeasure = $(this).data("countermeasure");
            if (countermeasure) {
              selectedItems = selectedItems.concat(groupedData[countermeasure]);
            }
          });
          console.log(selectedItems);
          return selectedItems;
        }

        // Function to export data to CSV
        function exportToCSV(data) {
          console.log(data);
          const baseUrl = window.location.origin; // Get the base URL from the current URL

          const csvRows = [];

          // Build headers by excluding the 'index' key
          const headers = Object.keys(data[0]).filter(
            (header) =>
              header !== "index" &&
              header !== "id" &&
              header !== "CountermeasureID"
          );
          csvRows.push(headers.join(","));

          data.forEach((item) => {
            const values = headers.map((header) => {
              // Update 'img' key to include the full URL
              if (header === "img") {
                return JSON.stringify(
                  `${baseUrl}/core/images/countermeasures/${item[header] || ""}`
                );
              } else {
                return JSON.stringify(item[header] || "");
              }
            });
            csvRows.push(values.join(","));
          });

          const csvContent = csvRows.join("\n");
          const blob = new Blob([csvContent], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "selected_countermeasures.csv";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        // Function to export data to PDF
        function exportToPDF(data) {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF("landscape", "pt", "a4"); // Set to landscape and adjust to A4 size

          // Exclude the 'index' and 'img' keys
          // const headers = Object.keys(data[0]).filter(
          //   (header) =>
          //     header !== "index" &&
          //     header !== "img" &&
          //     header !== "id" &&
          //     header !== "CountermeasureID"
          // );
          const headers = [
            "Emphasis Area",
            "Target Crash Type",
            "Land Use Type",
            "Countermeasure",
            "SSA Element",
            "SSA Hierarchy",
            "AASHTO",
          ];
          const rows = data.map((item) =>
            headers.map((header) => item[header] || "")
          );
          const SSAHierarchy = $("#SSAHierarchy").val().toLowerCase();
          const focusArea = $("#focusArea").val().toLowerCase();
          const targetCrash = $("#targetCrash").val().toLowerCase();
          const areaType = $("#areaType").val().toLowerCase();
          // const equityConsideration = $("#equity").val().toLowerCase();

          let headerString = "";
          if (SSAHierarchy) headerString += `SSA Hierarchy: ${SSAHierarchy}`;
          if (focusArea) headerString += `, Emphasis Area: ${focusArea}`;
          if (targetCrash) headerString += `, Target Crash: ${targetCrash}`;
          if (areaType) headerString += `, Area Type: ${areaType}`;
          // if (equityConsideration)
          //   headerString += `, Equity: ${equityConsideration}`;
          headerString += `, Total: ${rows.length}`;

          // Add title
          doc.setFontSize(10); // Set a smaller font size
          doc.text(
            `Selected Countermeasures ${
              headerString.length ? `(${headerString})` : ""
            }`,
            10,
            10
          );

          // Configure autoTable options
          doc.autoTable({
            head: [headers],
            body: rows,
            startY: 25, // Start a bit lower on the page to make room for the title
            margin: { top: 40, right: 5, bottom: 10, left: 5 }, // Narrow margins
            styles: {
              fontSize: 8, // Smaller font size for table content
              cellPadding: 2, // Reduce cell padding
            },
            headStyles: {
              fillColor: [0, 102, 204], // Set header color
              fontSize: 6, // Smaller font size for headers
              halign: "left",
            },
            columnStyles: {
              0: { cellWidth: "auto" }, // Adjust the first column width
            },
          });

          doc.save("selected_countermeasures.pdf");
        }

        // Add this JavaScript to update modal content
        function updateModalContent(countermeasure) {
          if (!countermeasure) return;
          
          // Update CMF Clearinghouse content
          $('#cmfContent').html(`CMF Clearinghouse data for: ${countermeasure.Countermeasure}<br>
                                CMF: ${countermeasure.CMF || 'N/A'}<br>
                                Star Quality: ${countermeasure['Star Quality'] || 'N/A'}`);
          
          // Update Knowledge Base content
          $('#kbContent').html(`Knowledge Base for: ${countermeasure.Countermeasure}<br>
                               Description: ${countermeasure['Knowledge Base'] || 'N/A'}`);
          
          // Update Countermeasure Fact Sheet content
          $('#cmfsContent').html(`Fact Sheet for: ${countermeasure.Countermeasure}<br>
                                 Details: ${countermeasure['Countermeasure Factsheet'] || 'N/A'}`);
        }

        // Add click handlers for the modal triggers
        $('[data-target="#cmfModal"], [data-target="#kbModal"], [data-target="#cmfsModal"]').on('click', function(e) {
          console.log(e);
          e.preventDefault();
          // Get the current countermeasure data
          const currentCard = $(this).closest('.selectable-card');
          console.log(currentCard);
          const countermeasureId = currentCard.data('countermeasure');
          const countermeasure = groupedData[countermeasureId]?.[0];
          
          updateModalContent(countermeasure);
        });
      });
    </script>
  </body>
</html>
